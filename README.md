# Sample and Hold System using Switched Capacitor Amplifier

**Implemented and verified the circuit using TSMC 40nm Process Design Kit in Cadence Virtuoso.**

## Project Context & Scope

This repository documents an ***independent study into mixed-signal IC design***, undertaken during my sophomore year (Year 2). As an autodidactic initiative bridging the gap between fundamental coursework, and mixed-signal topologies (for example, switched-capacitor circuits) taught in EE4323. This project represents a fully independent effort, executed without academic supervision, to explore the complexities of analog-digital interfaces.

The primary objective was to prioritize architectural understanding and design intuition to establish a functional proof-of-concept. Consequently, **the current implementation focuses on qualitative analysis and simulation-based verification rather than rigorous quantitative optimization**. While the circuit demonstrates successful operation, detailed theoretical derivations and parametric fine-tuning are reserved for future iterations. Future work is planned to incorporate detailed hand-calculations for fine-tuning slew rates and settling times.



## 1. Main Circuit: Sample and hold circuit

### a. Purpose:
* The circuit aims to increase the stability of signals by sampling and holding the signals and prevents from any changes at this time.
* This helps in conversion of simple signals into advance signals (with less noise) in analog to digital converters (ADCs).

![full schematic sample and hold](https://github.com/user-attachments/assets/0b83f229-6bae-4d7f-a810-20a1264346b3)

<img width="940" height="816" alt="image" src="https://github.com/user-attachments/assets/6cbdb68e-b8fd-45d5-a4d3-a33bdaa4a509" />



### b. Brief overview of the performance of the circuit:

#### i. DC operating points:
* **VDD** = 1.2V
* **VCC** = 0.9V
* **Total DC current consumption** = 139.95uA

#### ii. Accuracy
The transient simulation is carried out when the input signal is fed into the input capacitor and thus the inverting terminal of the op amp.

**Input signal specifications:**
* DC voltage = 0.5V
* AC sine wave amplitude = 0.1V
* Frequency = 5kHz

**Formula:**

$$Accuracy = \frac{\text{actual amplitude}}{\text{ideal amplitude}} \times 100%\$$

**i) At peak point:**
* Ideal amplitude: +100mV
* Actual amplitude: +98.5767mV
* **Accuracy = 98.58%**

**ii) At lowest point:**
* Ideal amplitude: -100mV
* Actual amplitude: -98.2662mV (measured from waveform = 401.7338mV)
* **Accuracy = 98.27%**

* **Worst-case accuracy = 98.27%**

The diagram below shows the sample and hold circuit output waveform in green compared to ideal output waveform in red.

<img width="940" height="442" alt="image" src="https://github.com/user-attachments/assets/9fcfffbd-944b-4fe0-8050-69f7183bbe38" />


The same waveform zoomed in within one period is shown below:

<img width="940" height="443" alt="image" src="https://github.com/user-attachments/assets/aab99423-7f8a-4e8e-8497-69abcdf7f1a0" />


### c. Future works:
* The settling time can be made small by making the UGBW of the main amplifier large.
* If either the slew-rate or UGBW are too small, the output waveform will be distorted and looks like a triangle.

---

The entire circuit can be categorized into analog and digital blocks.

## Analog blocks

### 2. Bandgap reference:

#### a. Topology
Based on the topology introduced in the article: *Curvature-compensated BiCMOS bandgap with 1-V supply voltage* by P. Malcovati; F. Maloberti; C. Fiocchi; M. Pruzzi, which includes a nonconventional op-amp which operates from the 0.9V power supply.

#### b. Implementation Details
The output reference voltage generated by the current-mode voltage reference circuit is passed through a unity-gain buffer (designed using the folded-cascode topology) first before supplying it to the non-inverting input of the main amplifier to reduce the noise generated by the current mode voltage reference circuit.

#### c. Specifications of the circuit:
* Required supply voltage = 0.9 V
* Output reference voltage = 500.0019mV at 27 degrees Celsius.
* Total current consumption: 55.63uA

The Bandgap reference circuit with a unity-gain buffer connected at the output is shown in the diagram below.

<img width="940" height="533" alt="image" src="https://github.com/user-attachments/assets/1211f253-53a4-4cce-9b19-8c955c0ada71" />

The schematic of the bandgap reference circuit is shown below

<img width="940" height="230" alt="image" src="https://github.com/user-attachments/assets/ec1ac228-8bee-4eee-9821-7cb87ebe4528" />

#### d. Circuit performance
**Temperature coefficient ($ppm/^\circ C$)** (measured from -10 degrees Celsius to 110 degrees Celsius)

$$TC = \frac{V_{max} - V_{min}}{V_{nominal}} \times \frac{10^6}{T_{max} - T_{min}} \text{ (ppm/deg Celsius)}$$

**Calculation:**
$$TC = \frac{539.5411mV - 498.9678mV}{0.5V} \times \frac{10^6}{110 - (-10)} = 676.22 \text{ (ppm/deg Celsius)}$$

<img width="940" height="446" alt="image" src="https://github.com/user-attachments/assets/49f98f26-c0c2-4677-b604-71e2d7e4db7f" />

#### e. Future works:
* The start-up transistor M4 did not turn off during normal operation as intended, as it was a trade-off made to prevent oscillations in the output reference voltage during startup, since the circuit had trouble in starting up entirely when M4 is switched off briefly after startup. This will affect the normal operation of the op amp.
* One suggested approach is to increase the W/L for the output branch, that way, a quiescent DC voltage of 0.5 V can be achieved without increasing the resistor in the output branch by too much, which in turn can make both the PTAT and CTAT voltage's coefficient smaller.
* Further refinements can be done by adjusting the values of the resistor using the below equation highlighted in the article, to improve the temperature coefficient performance.

<img width="617" height="194" alt="image" src="https://github.com/user-attachments/assets/ccc34ea1-1ac3-49a6-a31a-088537c695a4" />


* Curvature compensation method can be implemented in the bandgap architecture as highlighted in the article.
* The unity gain buffer can be optimized to achieve a high open-loop gain (increase length of the cascode transistors), a good enough unity-gain bandwidth value (increase width of the input pair), as well as a low current consumption (reduce the current source bias current).

---

### 3. Wide Swing Constant-Transconductance Biasing Circuit

#### a. Purpose:
To provide the necessary biasing voltages to the main amplifier and the unity gain buffer.

#### b. Biasing voltages:
* Vbp = 697.34mV
* Vcp = 525.47mV
* Vcn = 568.88mV
* Vbn = 452.56mV

The Wide Swing Constant-Transconductance Biasing Circuit within the top level schematic is shown in the diagram below.

<img width="606" height="381" alt="image" src="https://github.com/user-attachments/assets/03b0c171-d7f0-4ecf-95e4-5f52a9ee0dfd" />

<img width="297" height="377" alt="image" src="https://github.com/user-attachments/assets/8296f390-b26f-4f36-90cb-8bcbfa390f2c" />

The schematic of the Wide Swing Constant-Transconductance Biasing Circuit is shown below

<img width="940" height="548" alt="image" src="https://github.com/user-attachments/assets/0c3004f9-7991-4cbf-bf5d-84fef32c1ca7" />


#### c. Biasing circuitry brief explanations:
* A biasing resistor $R_0$ is added to provide the constant-gm property.
* The length of the cascode transistors are usually made larger than that of current-mirror transistor to ensure that the operation region of cascode transistors do not fall into triode region.

#### d. Start-up behavior
The circuit can be self-started, the diagram below shows the voltage changes during circuit start-up.

<img width="940" height="443" alt="image" src="https://github.com/user-attachments/assets/98d12a9b-16c8-40ec-a5c6-548ea2cdc4b3" />


#### e. Future works:
* Further tuning of the biasing voltages can be controlled with appropriate sizing of transistors, and resistor value, to improve the performance of the OTA.
* To ensure the minimum output voltage is small enough for “wide-swing” property, the W/L of M17 can be set to a larger value.
* Sooch’s approach can be implemented to solve issues due to non-ideal behaviours associated with transistors with different aspect ratios.

---

### 4. Operational Transconductance Amplifier (OTA) (Folded-cascode):

#### a. Justifications:
* OTA can be used since they can drive capacitive load in switched capacitor circuits.
* The folded-cascode design has a reasonably good output swing, fast settling time, high gain and good stability due to one dominant output pole.
* For input differential pair, NMOS can provide higher gain and higher speed, but PMOS has lower flicker noise which is more suitable in SC-application.
* <img width="760" height="370" alt="image" src="https://github.com/user-attachments/assets/155ee485-6ed5-46cc-8e69-ca152844e77a" />


The Operational Transconductance Amplifier within the top level schematic is shown in the diagram below.

<img width="940" height="438" alt="image" src="https://github.com/user-attachments/assets/d5d85d7f-180b-4388-b1f4-0b2797c1ada1" />

The schematic of the Operational Transconductance Amplifier is shown below

<img width="940" height="671" alt="image" src="https://github.com/user-attachments/assets/3efb55f3-568e-425c-a512-477f65651844" />


#### b. Brief overview of the op-amp performance:
* Loop gain = 60.229dB
* BW = 273.743kHz, sufficient for usual switched-cap operating frequency at 0.1525MHz
* Phase Margin = 24.697deg
* UGBW = 70.931MHz
* Gain margin = 19.624dB @ 234.98MHz

<img width="940" height="448" alt="image" src="https://github.com/user-attachments/assets/d878996b-75be-4d2d-8442-b3da4227b8b9" />


#### c. Future works:
* The circuit can be further tuned using calculations to achieve better stability and higher slew rate, where the long settling time of the switched capacitor circuit is suspected to be caused by insufficient current supplied to the output branch.

---

## Digital blocks

### 5. Inverter-based ring oscillator:

#### a. Purpose:
To generate a clock signal to be fed into the frequency divider.

#### b. Theory:
The oscillating frequency is dependent on the gate delay. If the gate delay of each inverter is $t_D$, then the oscillation frequency is simply:
$$f = \frac{1}{6t_D}$$

The inverter-based ring oscillator within the top level schematic is shown in the diagram below.

<img width="940" height="433" alt="image" src="https://github.com/user-attachments/assets/34ff0289-c0de-491b-bb48-d3ea3277588f" />

The internal schematic of the inverter is shown below:

<img width="539" height="468" alt="image" src="https://github.com/user-attachments/assets/2516986d-adbc-4a69-91f2-1329c7e3447f" />


#### c. Circuit performance:
* Oscillating frequency = 10.257MHz

<img width="940" height="443" alt="image" src="https://github.com/user-attachments/assets/a6ea3101-ce7d-474e-b4de-cc095eb27a8c" />


---

### 6. Frequency Divider:

#### a. Purpose:
An asynchronous mod-64 counter which divides the frequency by 64.

#### b. Objective:
To achieve the operating frequency of 0.1525MHz from the input frequency of 10.257MHz.

<img width="940" height="446" alt="image" src="https://github.com/user-attachments/assets/377406ff-0bae-43b1-9d09-ecc11c76b723" />


#### c. Schematic:
Below shows the schematic of the frequency divider which consists of 6 D flip flops.

<img width="940" height="801" alt="image" src="https://github.com/user-attachments/assets/ccd1b9db-3589-46c2-b85f-25708cdf62d1" />


#### d. D Flip-Flop Implementation:
The schematic below shows the internal structure of the D flip-flop, implemented using transmission-gate latch-based master-slave D flip-flop triggered at falling edge, where W = 200n, L = 100n.

As opposed to the conventional NAND-NOR D flip-flop, transmission gate-based flip-flops exhibit the best power-performance trade-off, according to the thesis *‘Comparative study on low-power high-performance flip-flops’* by Saeeid Tahmasbi Oskuii.

<img width="940" height="716" alt="image" src="https://github.com/user-attachments/assets/b51902a7-f28c-478a-99fa-a1a0a50e760a" />


---

### 7. Biphasic Clock Generator:

#### a. Purpose:
To generate two complementary clocks, which one has slightly less duty ratio than the other, so that the switches which are driven by these two clocks will not turn on or off at the same time.

The Biphasic Clock Generator within the top level schematic is shown in the diagram below.

<img width="738" height="573" alt="image" src="https://github.com/user-attachments/assets/af38a85a-ab2d-4123-8287-c2921a131d8d" />

The schematic of the Biphasic Clock Generator is shown below

<img width="940" height="339" alt="image" src="https://github.com/user-attachments/assets/5f9f4f17-d2e5-47bc-833c-6827992a8a97" />


#### b. Performance:
* The circuit provided an off interval of approximately **0.1259ns** at 0.1525MHz supplied.
* The off-interval is made this small to avoid a large spike at the output of the final switched-capacitor amplifier circuit.

<img width="940" height="445" alt="image" src="https://github.com/user-attachments/assets/c0d5f1f2-e896-42fd-954e-03cb3be3a3f4" />

<img width="940" height="444" alt="image" src="https://github.com/user-attachments/assets/4adb1891-d3aa-45a9-bdc6-0e6b03fd7759" />

